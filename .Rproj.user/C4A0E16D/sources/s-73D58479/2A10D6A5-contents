---
title: "pset_2"
author: "Student ID: 12173883"
date: "October 16, 2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)

rm(list=ls())

library(haven)
library(tidyverse)
library(broom)
library(knitr)
library(labelled)
library(gridExtra)
library(rdd)
data <- read_dta("almond_etal_2008.dta")
```

### Question 1

Summary stats of birthweight are presented below
```{r Q1}
data %>% summarize(mean = mean(bweight),
                               std_dev = sd(bweight),
                               min = min(bweight),
                               max = max(bweight)) %>%
                                                      kable()
```


### Question 2

There does appear to be a discontinuity at the low birth weight threshold. The pattern for 28-day and 1 year mortality is similar: mortality rates are higher with low birthweight babies, and drop gradually as the babys' weights increase. However, right at the 1500 gram cutoff (Bin 0), the mortality rate jumps up again, before falling again as birthweight increases. 

With the exception of the very first bin (the lowest birthweight babies), all bins have between 29000-39000 observations. While the bins over the threshold generally have more observations than the bins below the threshold, I do not anticipate this to cause any issues. The precision of the mean estimates for bins below the threshold will be slightly less, but the sample size is still so large that this shouldn't be a problem. The very first bin has just 3271 observations, much less than the other bins. In the discontinuity graphs, this bin is a clear outlier, with a much lower mortality rate than the bin above it, contrary to the general trend of higher birthweights having lower mortality. This is potentially because of the very low sample size of the bin and resulting imprecision, or perhaps those are the babies with the lowest gestational age, and those that don't survive are charcterized as miscarriages/fetal deaths rather than infant deaths.

```{r Q2}
#make the bins
data$bin <- ifelse(data$bweight < 1500, (((1500-data$bweight) %/% 28.35) * -1 - 1), 
                                        (((1500-data$bweight) %/% -28.35) + 1))

#collapse data to mean mortality rates by bin
RDD_plot <- group_by(data, bin) %>% summarize(mortality_28 = mean(agedth4, na.rm = T),
                                              mortality_1_yr = mean(agedth5, na.rm = T),
                                              count = length(agedth4),
                                              mom_age = mean(mom_age, na.rm = T),
                                              mom_edu = mean(mom_ed1, na.rm = T),
                                              gestation = mean(gest, na.rm = T),
                                              nprenatal = mean(nprenatal, na.rm = T),
                                              yob = mean(yob, na.rm = T))

RDD_plot$VLBW <- ifelse(RDD_plot$bin < 0, 0, 1) %>% factor()

#plot the data
ggplot(RDD_plot, aes(x = bin, y = mortality_28, col = VLBW))+ 
  geom_point() +
  labs(x = "Birthweight Bins",
       y = "Mortality Rate",
       title = "28 Day Mortality Rate by Birthweight Bin") +
  geom_vline(xintercept = 0, col = "red", alpha = 0.2) + 
  geom_smooth()

ggplot(RDD_plot, aes(x = bin, y = mortality_1_yr, col = VLBW))+ 
  geom_point() +
  labs(x = "Birthweight Bins",
       y = "Mortality Rate",
       title = "1 Year Mortality Rate by Birthweight Bin") +
  geom_vline(xintercept = 0, col = "red", alpha = 0.2) + 
  geom_smooth()

#show number of obserations in each bin
select(RDD_plot, bin, count) %>% kable()
```


### Question 3

I believe that for the most part this is a reasonable assumption. Pregnant women are not (as far as I know) able to manipulate the weights of their fetuses, even if they had knowledge of the crucial threshold birthweight value.

The other possibility for manipulation would be for the healthcare professionals to alter the recorded birthweights of babies from just above to just under the threshold for them to qualify for better care, (or the other way to save money).

If there was such manipulation happening, we would expect to see some bunching of density just above or just below the threshold in the distribution of weights. At a higher binwidth, the distribution seems to be relatively smooth, but at smaller binwidths some very irregular patterns appear at some round numbers and the gram equivalents of ounce intervals. The unusually common birthweights do not, however, appear to occur in a pattern that suggests bunching (right at the 1500 threshold), so I feel comfortable with the assumption that participants did not manipulate the running variable.

```{r Q3}
ggplot(data, aes(x=bweight)) + 
  geom_histogram(binwidth=30)

ggplot(data, aes(x=bweight)) + 
  geom_histogram(binwidth=10)
```

### Question 4

There is not any evidence of discontinuities on other covariates around the very low birth weight threshold, with perhaps the exception of year of birth. This makes sense, given that medical technology has improved over th years. The problem with potential imbalances in covariates is that they could affect my RDD estimates if they not only affected treatment status but also the dependent variable of mortality. This would confound the treatment effect. It is easy to imagine how education levels of the mother or gestational age could impact mortality, so it is a good there there does not appear to be correlation between those variables and the treatment. Regarding year of birth, the imbalance there could be addressed by adding it as a control in the regression.

```{r Q4}
p1 <- ggplot(RDD_plot, aes(x = bin, y = mom_age, col = VLBW))+ 
  geom_point() +
  labs(x = "Birthweight Bins",
       y = "Mom's Average Age at Birth",
       title = "Mom's Age by Birthweight Bin") +
  geom_vline(xintercept = 0, col = "red", alpha = 0.2) + 
  geom_smooth()

p2 <- ggplot(RDD_plot, aes(x = bin, y = mom_edu, col = VLBW))+ 
  geom_point() +
  labs(x = "Birthweight Bins",
       y = "Percentage of Moms with less than High School Ed",
       title = "Mom's Education by Birthweight Bin") +
  geom_vline(xintercept = 0, col = "red", alpha = 0.2) + 
  geom_smooth()

p3 <- ggplot(RDD_plot, aes(x = bin, y = gestation, col = VLBW))+ 
  geom_point() +
  labs(x = "Birthweight Bins",
       y = "Average Gestational Age",
       title = "Gestational Age by Birthweight Bin") +
  geom_vline(xintercept = 0, col = "red", alpha = 0.2) + 
  geom_smooth()

p4 <- ggplot(RDD_plot, aes(x = bin, y = nprenatal, col = VLBW))+ 
  geom_point() +
  labs(x = "Birthweight Bins",
       y = "Average Prenatal Visits",
       title = "Prenatal Vists by Birthweight Bin") +
  geom_vline(xintercept = 0, col = "red", alpha = 0.2) + 
  geom_smooth()

p5 <- ggplot(RDD_plot, aes(x = bin, y = yob, col = VLBW))+ 
  geom_point() +
  labs(x = "Birthweight Bins",
       y = "Average Year of Birth",
       title = "Year of Birth by Birthweight Bin") +
  geom_vline(xintercept = 0, col = "red", alpha = 0.2) + 
  geom_smooth()

grid.arrange(p1, p2, p3, p4, p5, nrow = 3)
```

### Question 5

The VLBW coefficient (a1) in the 28 day model shows that the 28 day mortality rate for babies below 1500 grams was 0.0088 less than babies above 1500 grams, which is quite a difference considering the bin average for babies in the bin just above 1500g is 0.044.
The a1 coefficient for the 1 yr model shows the mortality rate is .0095 less for babies below the threshold, which is also quite a large difference considering the bin mean of babies just above the threshold is .0615.

The a2 and a3 coefficients show the difference in slopes of the running variable above and below the threshold. For both 28 day and 1 yr models, each additional gram of weight decreases mortality. Also in both models, the reductions in mortality for each gram are less below the threshold than above.

```{r Q5}

bandwidth_85 <- between(data$bweight, 1500 - 85,  1500 + 85)
data$VLBW <- ifelse(data$bweight < 1500, 1, 0) 
data <- mutate(data, bw_minus_15 = bweight - 1500)

model <- lm(agedth4 ~ VLBW + I(VLBW * bw_minus_15) + I((1 - VLBW) * bw_minus_15),
            data = data,
            subset = bandwidth_85)
summary(model)$coefficients %>% kable()

model_yr <- lm(agedth5 ~ VLBW + I(VLBW * bw_minus_15) + I((1 - VLBW) * bw_minus_15),
            data = data,
            subset = bandwidth_85)
summary(model_yr)$coefficients %>% kable()

```

### Question 6

Adding covariates as controls to the models lowers the magnitude of the a1, a2, and a3 coefficients for both 28 day and 1 year models, and does not change the standard errors much. This suggests that the sample may not be perfectly balanced between the treatment groups, and indeed the coefficients for covariates such as race, low education, and prenatal visits are relatively large and significant. However, all of the RDD coefficients remain negative and significant, so the overall treatment effect is consistent, just smaller in magnitude. 

```{r Q6}
model_cov <- lm(agedth4 ~ VLBW + I(VLBW * bw_minus_15) + I((1 - VLBW) * bw_minus_15) + mom_age + mom_race + mom_ed1 + mom_ed2 + mom_ed3 + mom_ed4 + mom_ed5 + yob + gest_wks1 + gest_wks2 + gest_wks3 + gest_wks4 + nprenatal_1 + nprenatal_2 + nprenatal_3 + nprenatal_4,
            data = data,
            subset = bandwidth_85)

model_cov_yr <- lm(agedth5 ~ VLBW + I(VLBW * bw_minus_15) + I((1 - VLBW) * bw_minus_15) + mom_age + mom_race + mom_ed1 + mom_ed2 + mom_ed3 + mom_ed4 + mom_ed5 + yob + gest_wks1 + gest_wks2 + gest_wks3 + gest_wks4 + nprenatal_1 + nprenatal_2 + nprenatal_3 + nprenatal_4,
            data = data,
            subset = bandwidth_85)


summary(model_cov)$coefficients %>% kable()
summary(model_cov_yr)$coefficients %>% kable()

```

### Question 7

When the caliper sizes are changed for the 28 day and 1 yr models, we see that the a1, a2, a3 coefficients get progressively smaller in magnitude as the bandwidth increases (however they stay negative). We also see that the the p-values get smaller as bandwidth increases, showing that our estimates' precision increases as the sample size gets larger. The tradeoff we face when changing the calipers is an increase in precision with larger bandwidth, but also an increase in bias: the further from the cut off we get, the less likely that the babies on either side of the threshold are truly similar in unobservables.

```{r Q7}
bandwidth_120 <- between(data$bweight, 1500 - 120,  1500 + 120)
bandwidth_30 <- between(data$bweight, 1500 - 30,  1500 + 30)


model_30 <- lm(agedth4 ~ VLBW + I(VLBW * bw_minus_15) + I((1 - VLBW) * bw_minus_15) + mom_age + mom_race + mom_ed1 + mom_ed2 + mom_ed3 + mom_ed4 + mom_ed5 + yob + gest_wks1 + gest_wks2 + gest_wks3 + gest_wks4 + nprenatal_1 + nprenatal_2 + nprenatal_3 + nprenatal_4,
            data = data,
            subset = bandwidth_30)

model_120 <- lm(agedth4 ~ VLBW + I(VLBW * bw_minus_15) + I((1 - VLBW) * bw_minus_15) + mom_age + mom_race + mom_ed1 + mom_ed2 + mom_ed3 + mom_ed4 + mom_ed5 + yob + gest_wks1 + gest_wks2 + gest_wks3 + gest_wks4 + nprenatal_1 + nprenatal_2 + nprenatal_3 + nprenatal_4,
            data = data,
            subset = bandwidth_120)

model_30_yr <- lm(agedth5 ~ VLBW + I(VLBW * bw_minus_15) + I((1 - VLBW) * bw_minus_15) + mom_age + mom_race + mom_ed1 + mom_ed2 + mom_ed3 + mom_ed4 + mom_ed5 + yob + gest_wks1 + gest_wks2 + gest_wks3 + gest_wks4 + nprenatal_1 + nprenatal_2 + nprenatal_3 + nprenatal_4,
            data = data,
            subset = bandwidth_30)

model_120_yr <- lm(agedth5 ~ VLBW + I(VLBW * bw_minus_15) + I((1 - VLBW) * bw_minus_15) + mom_age + mom_race + mom_ed1 + mom_ed2 + mom_ed3 + mom_ed4 + mom_ed5 + yob + gest_wks1 + gest_wks2 + gest_wks3 + gest_wks4 + nprenatal_1 + nprenatal_2 + nprenatal_3 + nprenatal_4,
            data = data,
            subset = bandwidth_120)

summary(model_30)$coefficients %>% kable()
summary(model)$coefficients %>% kable()
summary(model_120)$coefficients %>% kable()

summary(model_30_yr)$coefficients %>% kable()
summary(model_yr)$coefficients %>% kable()
summary(model_120_yr)$coefficients %>% kable()

```

### Question 8

From the models above, we can say that babies born at weights below 1500 grams have lower 28 day and 1 year mortality rates than babies born above 1500 grams. Given that this is the coventional threshold for VLBW status, at which point doctors prescribe additional medical treatment, and that balance in baseline covariates for groups above and below the threshold is relatively equal, (and the additional work that the Almond et al paper does to identify treatment mechanisms through common procedures), we can say that this difference is a causal estimate of the treatment effect of additional medical expeditures on infant mortality. One concern about such a CBA is its external validity: if the cost of medical services differ significantly between states (and for states not in this sample) then the outcomes of the CBA may be misleading.

In order to make a cost-benefit analysis of this treatment, I would need to know the average or median costs of the medical services performed (noting that there could be both extensive and intensive marginal costs because some VLBW babies could have many more procedures than other VLBW babies). I would also need to know some of the common parameters used in CBA analyses, such as the specific value of statistical life we would use, and what discount rate should be applied.


### Student Name: Cory Rand

